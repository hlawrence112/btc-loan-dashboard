<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC-Backed Loan Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121823;--muted:#1a2332;--text:#e8f0ff;--sub:#9fb3c8;--accent:#4dd0e1;--good:#23d18b;--warn:#ffd166;--bad:#ff5c77;
    }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#0b0f14,#0a0e13 60%,#090c12)}
    header{position:sticky;top:0;z-index:5;background:rgba(10,14,19,.8);backdrop-filter:blur(8px);border-bottom:1px solid #182030}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:6px 0 2px;font-size:22px}
    .sub{color:var(--sub);font-size:13px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-2{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--panel);border:1px solid #1c2535;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263147;background:#0e1420;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:2px solid #355184}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:var(--muted);margin-bottom:8px}
    .kpi .v{font-weight:700}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .good{background:rgba(35,209,139,.12);border:1px solid rgba(35,209,139,.35);color:var(--good)}
    .warn{background:rgba(255,209,102,.12);border:1px solid rgba(255,209,102,.4);color:var(--warn)}
    .bad{background:rgba(255,92,119,.12);border:1px solid rgba(255,92,119,.4);color:var(--bad)}
    .footer{color:#7f93ac;text-align:center;padding:30px 10px}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    .btn{cursor:pointer;background:#1a2a44;border:1px solid #2a3b5f}
    .btn:hover{background:#203054}
    .small{font-size:12px}
    .news-item{padding:10px;border-bottom:1px solid #1e2839}
    .news-item a{color:#b8d6ff;text-decoration:none}
    canvas{width:100%;height:280px}
    .tag{padding:2px 8px;border-radius:12px;background:#0f1724;border:1px solid #23314a;color:#9fb3c8;font-size:11px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>BTC-Backed Loan Dashboard</h1>
      <div class="sub">Client-side app (no server). Data saved to your browser via <b>localStorage</b>.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid cols-3">
      <section class="card" id="loanInputs">
        <h2>Loan & Collateral</h2>
        <div class="row">
          <div>
            <label>Loan Amount (USDC/USD)</label>
            <input type="number" id="loanAmount" step="0.01" placeholder="1000" />
          </div>
          <div>
            <label>APR (%)</label>
            <input type="number" id="apr" step="0.01" placeholder="7.35" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Collateral BTC</label>
            <input type="number" id="collateralBtc" step="0.00000001" placeholder="0.02952035" />
          </div>
          <div>
            <label>Purchased BTC (from loan)</label>
            <input type="number" id="purchasedBtc" step="0.00000001" placeholder="0.00848273" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Target LTV (%)</label>
            <input type="number" id="targetLtv" step="0.01" placeholder="30" />
          </div>
          <div>
            <label>Liquidation LTV (%)</label>
            <input type="number" id="liqLtv" step="0.01" placeholder="86" />
          </div>
        </div>
        <div class="flex" style="margin-top:12px">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn" id="exportBtn">Export JSON</button>
          <label class="btn" style="position:relative;overflow:hidden">
            Import JSON
            <input type="file" id="importFile" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer" />
          </label>
        </div>
        <div class="small" style="margin-top:8px;color:#9fb3c8">Tip: edit fields, hit <b>Save</b>. Values persist automatically.</div>
      </section>

      <section class="card" id="status">
        <h2>Status & Risk</h2>
        <div class="kpi"><div>Current BTC Price</div><div class="v" id="btcPrice">—</div></div>
        <div class="kpi"><div>Collateral Value</div><div class="v" id="collateralUsd">—</div></div>
        <div class="kpi"><div>Current LTV</div><div class="v" id="ltv">—</div></div>
        <div class="kpi"><div>Liquidation Price</div><div class="v" id="liqPrice">—</div></div>
        <div class="kpi"><div>Monthly Interest</div><div class="v" id="monthlyInterest">—</div></div>
        <div class="kpi"><div>Runway (months of interest buffer)</div><div class="v" id="runway">—</div></div>
        <div id="healthTag" class="pill" style="margin-top:8px">Health</div>
        <div class="flex" style="margin-top:10px">
          <button class="btn" id="markInterest">Mark Interest Paid</button>
          <button class="btn" id="addTopUp">Log Collateral Add</button>
          <button class="btn" id="addRepay">Log Principal Repay</button>
        </div>
      </section>

      <section class="card" id="pricesNews">
        <h2>Markets: BTC & XRP</h2>
        <div class="grid cols-2">
          <div class="kpi"><div>BTC Price</div><div class="v" id="btcTicker">—</div></div>
          <div class="kpi"><div>XRP Price</div><div class="v" id="xrpTicker">—</div></div>
        </div>
        <div class="grid cols-2">
          <div class="kpi"><div>BTC 24h</div><div class="v" id="btcChange">—</div></div>
          <div class="kpi"><div>XRP 24h</div><div class="v" id="xrpChange">—</div></div>
        </div>
        <div style="margin-top:8px" class="small">Prices from CoinGecko (client-side). Auto-refreshes every 60s.</div>
        <div style="margin-top:12px" class="flex">
          <span class="tag">News Feeds (client-side fetch)</span>
          <button class="btn" id="refreshNews">Refresh News</button>
        </div>
        <div id="newsList" style="max-height:260px;overflow:auto;margin-top:8px"></div>
      </section>
    </div>

    <section class="card" style="margin-top:14px">
      <h2>Scenario Simulator</h2>
      <div class="row">
        <div>
          <label>Simulated BTC Price (USD)</label>
          <input type="number" id="simPrice" step="1" placeholder="150000" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="runSim">Run Simulation</button>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="kpi"><div>LTV @ Sim Price</div><div class="v" id="simLtv">—</div></div>
        <div class="kpi"><div>Portfolio Value</div><div class="v" id="simValue">—</div></div>
        <div class="kpi"><div>Net (after loan)</div><div class="v" id="simNet">—</div></div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2>Activity Log</h2>
      <div id="log"></div>
    </section>

    <div class="footer small">Made for client-side use. Always double-check liquidation rules with your lender. Not financial advice.</div>
  </main>

  <script>
    const $=s=>document.querySelector(s);
    const fmtUSD=v=> isNaN(v)?'—': v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const fmtBTC=v=> isNaN(v)?'—': (Number(v).toFixed(8)+' BTC');
    const pct=v=> isNaN(v)?'—': (v.toFixed(2)+'%');

    const state = JSON.parse(localStorage.getItem('bbl_state')||'{}');

    // Defaults based on your latest screenshots
    const defaults={
      loanAmount:1000,
      apr:7.35,
      collateralBtc:0.02952035,
      purchasedBtc:0.00848273,
      targetLtv:30,
      liqLtv:86,
      interestBufferUSD: 150 // how much cash set aside for interest runway (editable by editing localStorage)
    };

    Object.assign(defaults,state);

    // Populate inputs
    $('#loanAmount').value=defaults.loanAmount;
    $('#apr').value=defaults.apr;
    $('#collateralBtc').value=defaults.collateralBtc;
    $('#purchasedBtc').value=defaults.purchasedBtc;
    $('#targetLtv').value=defaults.targetLtv;
    $('#liqLtv').value=defaults.liqLtv;

    function save(){
      const s={
        loanAmount: Number($('#loanAmount').value),
        apr: Number($('#apr').value),
        collateralBtc: Number($('#collateralBtc').value),
        purchasedBtc: Number($('#purchasedBtc').value),
        targetLtv: Number($('#targetLtv').value),
        liqLtv: Number($('#liqLtv').value),
        interestBufferUSD: defaults.interestBufferUSD,
        log: defaults.log || []
      };
      localStorage.setItem('bbl_state',JSON.stringify(s));
      Object.assign(defaults,s);
      render();
    }

    function reset(){ localStorage.removeItem('bbl_state'); location.reload(); }

    $('#saveBtn').onclick=save; $('#resetBtn').onclick=reset;

    // Activity log helpers
    function addLog(type, data){
      defaults.log = defaults.log || [];
      defaults.log.unshift({t:new Date().toISOString(),type,data});
      localStorage.setItem('bbl_state',JSON.stringify(defaults));
      renderLog();
    }

    $('#markInterest').onclick=()=>{
      const monthlyInt = defaults.loanAmount * (defaults.apr/100) / 12;
      addLog('interest_paid',{amount: monthlyInt});
    };
    $('#addTopUp').onclick=()=>{
      const amt = prompt('Add how much BTC to collateral? e.g. 0.002');
      if(!amt) return; 
      defaults.collateralBtc += Number(amt);
      addLog('collateral_add',{btc:Number(amt)});
      save();
    };
    $('#addRepay').onclick=()=>{
      const usd = prompt('Repay principal amount (USD)?');
      if(!usd) return;
      defaults.loanAmount -= Number(usd);
      if(defaults.loanAmount<0) defaults.loanAmount=0;
      addLog('principal_repay',{usd:Number(usd)});
      save();
    };

    function renderLog(){
      const el=$('#log');
      const list=(defaults.log||[]).map(x=>{
        const d=new Date(x.t).toLocaleString();
        if(x.type==='interest_paid') return `<div class='news-item'><b>Interest paid</b> ${fmtUSD(x.data.amount)} <span class='sub'>(${d})</span></div>`;
        if(x.type==='collateral_add') return `<div class='news-item'><b>Collateral added</b> ${fmtBTC(x.data.btc)} <span class='sub'>(${d})</span></div>`;
        if(x.type==='principal_repay') return `<div class='news-item'><b>Principal repaid</b> ${fmtUSD(x.data.usd)} <span class='sub'>(${d})</span></div>`;
        return `<div class='news-item'>${x.type} ${JSON.stringify(x.data)} <span class='sub'>(${d})</span></div>`;
      }).join('');
      el.innerHTML=list||'<div class="sub">No activity yet.</div>';
    }

    // Export / Import
    $('#exportBtn').onclick=()=>{
      const blob=new Blob([JSON.stringify(defaults,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bbl_state.json';a.click();
    };
    $('#importFile').onchange=(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const r=new FileReader();
      r.onload=()=>{ try{ const s=JSON.parse(r.result); localStorage.setItem('bbl_state',JSON.stringify(s)); Object.assign(defaults,s); render(); }catch(err){ alert('Invalid JSON'); } };
      r.readAsText(file);
    };

    // Price + News
    async function fetchPrices(){
      try{
        const url='https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ripple&vs_currencies=usd&include_24hr_change=true';
        const res=await fetch(url); const j=await res.json();
        const btc=j.bitcoin.usd; const btcCh=j.bitcoin.usd_24h_change;
        const xrp=j.ripple.usd; const xrpCh=j.ripple.usd_24h_change;
        $('#btcTicker').textContent=fmtUSD(btc);
        $('#xrpTicker').textContent=fmtUSD(xrp);
        $('#btcChange').textContent=(btcCh>=0?'+':'')+btcCh.toFixed(2)+'%';
        $('#xrpChange').textContent=(xrpCh>=0?'+':'')+xrpCh.toFixed(2)+'%';
        window.currentBtcPrice=btc; // store for calculations
        render();
      }catch(e){ console.warn('Price fetch failed',e); }
    }

    // Simple RSS fetchers (best-effort; some feeds may block CORS)
    async function fetchNews(){
      const feeds=[
        {name:'CoinDesk', url:'https://www.coindesk.com/arc/outboundfeeds/rss/?outputType=xml'},
        {name:'BTC Times', url:'https://btctimes.com/rss'}
      ];
      const listEl=$('#newsList'); listEl.innerHTML='<div class="sub">Loading…</div>';
      try{
        // Use allorigins proxy for CORS-friendly RSS-to-text
        const items=[];
        for(const f of feeds){
          const res=await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(f.url));
          const txt=await res.text();
          const doc=new DOMParser().parseFromString(txt,'text/xml');
          const arr=[...doc.querySelectorAll('item')].slice(0,5).map(n=>({
            title:n.querySelector('title')?.textContent||'Untitled',
            link:n.querySelector('link')?.textContent||'#',
            src:f.name,
            date:n.querySelector('pubDate')?.textContent||''
          }));
          items.push(...arr);
        }
        items.sort((a,b)=> new Date(b.date)-new Date(a.date));
        listEl.innerHTML = items.slice(0,10).map(i=>`
          <div class='news-item'>
            <a href='${i.link}' target='_blank' rel='noopener'>${i.title}</a>
            <div class='small sub'>${i.src} • ${new Date(i.date).toLocaleString()}</div>
          </div>`).join('');
      }catch(e){
        listEl.innerHTML = `<div class='sub'>News feeds blocked by CORS. Quick links: 
          <a href='https://www.coindesk.com/' target='_blank'>CoinDesk</a> •
          <a href='https://btctimes.com/' target='_blank'>BTC Times</a></div>`;
      }
    }

    $('#refreshNews').onclick=fetchNews;

    function compute(btcPrice){
      const loan=defaults.loanAmount;
      const collBTC=defaults.collateralBtc;
      const collUSD=collBTC * btcPrice;
      const ltv = loan / Math.max(collUSD,1) * 100;
      const liqPrice = (loan / (collBTC * (defaults.liqLtv/100)) ) || 0; // USD per BTC
      const monthlyInt = loan * (defaults.apr/100) / 12;
      const bufferMonths = defaults.interestBufferUSD / Math.max(monthlyInt,1e-6);
      const totalBtc = collBTC + defaults.purchasedBtc;
      const portfolioValue = totalBtc * btcPrice;
      const net = portfolioValue - loan;
      return {loan, collUSD, ltv, liqPrice, monthlyInt, bufferMonths, totalBtc, portfolioValue, net};
    }

    function render(){
      const price = window.currentBtcPrice || Number($('#btcPrice').dataset.fallback)|| 113000; // fallback
      const r = compute(price);
      $('#btcPrice').textContent = fmtUSD(price);
      $('#collateralUsd').textContent = fmtUSD(r.collUSD);
      $('#ltv').textContent = pct(r.ltv);
      $('#liqPrice').textContent = fmtUSD(r.liqPrice);
      $('#monthlyInterest').textContent = fmtUSD(r.monthlyInt);
      $('#runway').textContent = r.bufferMonths.toFixed(1)+' mo';

      const tag=$('#healthTag');
      tag.className='pill';
      if(r.ltv<35){ tag.classList.add('good'); tag.textContent='Health: Green (low risk)'; }
      else if(r.ltv<55){ tag.classList.add('warn'); tag.textContent='Health: Yellow (watch)'; }
      else { tag.classList.add('bad'); tag.textContent='Health: Red (act)'; }

      renderLog();
    }

    $('#runSim').onclick=()=>{
      const p=Number($('#simPrice').value||0); if(!p) return;
      const r=compute(p);
      $('#simLtv').textContent=pct(r.ltv);
      $('#simValue').textContent=fmtUSD(r.portfolioValue);
      $('#simNet').textContent=fmtUSD(r.net);
    };

    // Kickoff
    fetchPrices(); fetchNews(); render();
    setInterval(fetchPrices,60000);
  </script>
</body>
</html>
